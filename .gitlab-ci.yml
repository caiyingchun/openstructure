# these are the different stages for our pipelines
# jobs in the same stage run in parallel 
# next stage doesn't start until previous stage finishes with 'OK'
# by now we only do build and test, we could add another stage "deploy" if
# needed
stages:
  - build
  - test

# this is executed before doing anything else
before_script:
  - echo "Running global 'before_script'..."
  - yum -y -q -e 0 install tcl
  - yum -y -q -e 0 install glibc-devel
  - mkdir -p /scicore/soft/modules
  - ln -s /export/soft/apps/centos6/generic /scicore/soft/apps
  - ln -s /export/soft/modules/centos6/generic/all /scicore/soft/modules
  - source /export/soft/lua_lmod/centos6/lmod/lmod/init/bash
  - module use /scicore/soft/modules/all
  - module load CMake/2.8.12-goolf-1.4.10
  - module load Python/2.7.5-goolf-1.4.10
  - module load OpenBLAS/0.2.6-gompi-1.4.10-LAPACK-3.4.2
  - module load Eigen/3.2.1-goolf-1.4.10
  - module load numpy/1.9.1-goolf-1.4.10-Python-2.7.5
  - module load Boost/1.53.0-goolf-1.4.10-Python-2.7.5
  - module load OpenMM/6.1-Linux64
  - module load PyQt/4.11.4-goolf-1.4.10-Python-2.7.5
  - mkdir build-ci
  - cd build-ci
  - echo "... done running global 'before_script'."

# BUILD STAGE
build:centos6.6:
  stage: build
  image: centos:6.6
  script:
  - echo "Building on CentOS 6..."
  - cmake .. -DENABLE_MM=1
             -DOPEN_MM_LIBRARY=$EBROOTOPENMM/lib/libOpenMM.so
             -DOPEN_MM_PLUGIN_DIR=$EBROOTOPENMM/lib/plugins
             -DOPEN_MM_INCLUDE_DIR=$EBROOTOPENMM/include
             -DCOMPILE_TMTOOLS=1
             -DENABLE_GFX=OFF
             -DENABLE_GUI=OFF
             -DUSE_NUMPY=1
             -DUSE_RPATH=1
             -DPYTHON_ROOT=$EBROOTPYTHON
             -DEIGEN3_INCLUDE_DIR=$EBROOTEIGEN/include
             -DFFTW_LIBRARY=$EBROOTFFTW/lib/libfftw3f.a
             -DFFTW_INCLUDE_DIR=$EBROOTFFTW/include
             -DBOOST_ROOT=$EBROOTBOOST
             -DQT_QMAKE_EXECUTABLE=$EBROOTQT/bin/qmake
             -DCOMPOUND_LIB=$COMP_LIB
             -DOPTIMIZE=1
  - echo "... done building on CentOS 6."

# TESTS STAGE
test:centos6.6:
  stage: test
  image: centos:6.6
  script:
  - echo "Testing on CentOS 6..."
  - cat /etc/redhat-release
  - echo "... done testing on CentOS 6."
